#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
äº•å­—æ£‹AIå¯¹æˆ˜ç³»ç»Ÿ - ç¬¬ä¸€ç©å®¶ä¸»ç¨‹åº

æœ¬ç¨‹åºä½œä¸ºäº•å­—æ£‹æ¸¸æˆçš„ç¬¬ä¸€ç©å®¶ï¼ˆäººç±»ç©å®¶ï¼‰ä¸»æ§ç¨‹åºï¼Œè´Ÿè´£ï¼š
- é€šè¿‡æ‘„åƒå¤´å®æ—¶æ£€æµ‹äººç±»ç©å®¶çš„æ£‹å­æ”¾ç½®
- å¤„ç†æ¸¸æˆé€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
- è§¦å‘AIç©å®¶çš„ç§»åŠ¨å†³ç­–
- é€šè¿‡ä¸²å£é€šä¿¡æ§åˆ¶æœºæ¢°è‡‚æ‰§è¡ŒAIç§»åŠ¨
- æ£€æµ‹æ¸¸æˆç»“æŸæ¡ä»¶ï¼ˆè·èƒœ/å¹³å±€ï¼‰

ç³»ç»Ÿæ¶æ„:
1. è§†è§‰æ£€æµ‹æ¨¡å—ï¼šå®æ—¶æ•è·å’Œåˆ†ææ‘„åƒå¤´å›¾åƒ
2. æ¸¸æˆé€»è¾‘æ¨¡å—ï¼šå¤„ç†ç§»åŠ¨ã€æ£€æµ‹è·èƒœæ¡ä»¶
3. é€šä¿¡æ¨¡å—ï¼šä¸æœºæ¢°è‡‚è¿›è¡Œä¸²å£é€šä¿¡
4. AIå†³ç­–æ¨¡å—ï¼šä½¿ç”¨Minimaxç®—æ³•è®¡ç®—æœ€ä¼˜ç§»åŠ¨

ä½œè€…: poboll
é‚®ç®±: caiths@icloud.com
è®¸å¯è¯: MIT License (2023)

ä½¿ç”¨è¯´æ˜:
1. ç¡®ä¿æ‘„åƒå¤´æ­£ç¡®è¿æ¥å¹¶æ ¡å‡†
2. ç¡®ä¿ä¸²å£è®¾å¤‡æ­£ç¡®è¿æ¥
3. è¿è¡Œç¨‹åºåï¼Œäººç±»ç©å®¶å…ˆæ‰‹
4. åœ¨æ‘„åƒå¤´è§†é‡å†…æ”¾ç½®ç™½è‰²æ£‹å­
5. AIä¼šè‡ªåŠ¨è®¡ç®—å¹¶æ‰§è¡Œç§»åŠ¨
"""

# å¯¼å…¥æ¸¸æˆå†³ç­–ç›¸å…³å‡½æ•°
from decision import init_board, print_board, computermove, humanmove, winnerdetect, full
# å¯¼å…¥è§†è§‰æ£€æµ‹æ¨¡å—
from versionfirst import capture_and_process_image
# å¯¼å…¥ä¸²å£é€šä¿¡æ¨¡å—
from communication import send_message
# å¯¼å…¥ç³»ç»Ÿæ¨¡å—ç”¨äºè¾“å‡ºé‡å®šå‘
import io
import sys

def main():
    """
    äº•å­—æ£‹æ¸¸æˆä¸»æ§åˆ¶å¾ªç¯
    
    æ­¤å‡½æ•°å®ç°äº†å®Œæ•´çš„æ¸¸æˆæµç¨‹ï¼ŒåŒ…æ‹¬ï¼š
    1. åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
    2. å¾ªç¯æ£€æµ‹äººç±»ç©å®¶ç§»åŠ¨
    3. å¤„ç†AIç©å®¶å“åº”
    4. æ£€æµ‹æ¸¸æˆç»“æŸæ¡ä»¶
    5. é€šè¿‡ä¸²å£å‘é€æ§åˆ¶æŒ‡ä»¤
    
    æ¸¸æˆæµç¨‹:
    - äººç±»ç©å®¶å…ˆæ‰‹ï¼Œä½¿ç”¨ç™½è‰²æ£‹å­
    - AIç©å®¶åæ‰‹ï¼Œä½¿ç”¨é»‘è‰²æ£‹å­ï¼ˆç”±æœºæ¢°è‡‚æ”¾ç½®ï¼‰
    - å®æ—¶æ£€æµ‹ä½œå¼Šè¡Œä¸º
    - è‡ªåŠ¨åˆ¤æ–­æ¸¸æˆç»“æœ
    
    é€šä¿¡åè®®:
    - æ ¼å¼: "2{ç§»åŠ¨åºå·}{ä½ç½®}"
    - ç¤ºä¾‹: "214" è¡¨ç¤ºç¬¬1æ¬¡ç§»åŠ¨åˆ°ä½ç½®4
    
    å¼‚å¸¸å¤„ç†:
    - è‡ªåŠ¨å¤„ç†è§†è§‰æ£€æµ‹å¤±è´¥
    - æ£€æµ‹å¹¶é˜»æ­¢ä½œå¼Šè¡Œä¸º
    - å¤„ç†ä¸²å£é€šä¿¡å¼‚å¸¸
    """
    print("[ç³»ç»Ÿ] äº•å­—æ£‹AIå¯¹æˆ˜ç³»ç»Ÿå¯åŠ¨")
    print("[ç³»ç»Ÿ] äººç±»ç©å®¶ä½¿ç”¨ç™½è‰²æ£‹å­ï¼ŒAIä½¿ç”¨é»‘è‰²æ£‹å­")
    print("[ç³»ç»Ÿ] è¯·åœ¨æ‘„åƒå¤´è§†é‡å†…æ”¾ç½®æ£‹å­...\n")
    
    # åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
    chess = init_board()  # åˆ›å»ºç©ºæ£‹ç›˜
    detected_positions = set()  # è®°å½•å·²æ£€æµ‹åˆ°çš„æ£‹å­ä½ç½®
    print_board(chess)  # æ˜¾ç¤ºåˆå§‹æ£‹ç›˜
    computer_move_count = 0  # AIç§»åŠ¨è®¡æ•°å™¨
    
    print("[æ¸¸æˆ] æ¸¸æˆå¼€å§‹ï¼Œç­‰å¾…äººç±»ç©å®¶ç§»åŠ¨...")
    
    # ä¸»æ¸¸æˆå¾ªç¯
    while True:
        # æ­¥éª¤1: é€šè¿‡è§†è§‰æ£€æµ‹æ•è·äººç±»ç©å®¶çš„ç§»åŠ¨
        print("[æ£€æµ‹] æ­£åœ¨æ£€æµ‹æ–°çš„æ£‹å­...")
        move = capture_and_process_image(detected_positions)
        
        if move is not None:
            print(f"[æ£€æµ‹] æ£€æµ‹åˆ°äººç±»ç©å®¶åœ¨ä½ç½® {move[0]} æ”¾ç½®æ£‹å­")
            
            # æ­¥éª¤2: å¤„ç†äººç±»ç©å®¶ç§»åŠ¨å¹¶æ£€æµ‹ä½œå¼Š
            chess, position_changed = humanmove(chess, move[0], detected_positions)
            print_board(chess)
            
            # æ­¥éª¤3: æ£€æŸ¥äººç±»ç©å®¶æ˜¯å¦è·èƒœ
            if winnerdetect(chess, 1):
                print("\nğŸ‰ [æ¸¸æˆç»“æŸ] äººç±»ç©å®¶è·èƒœï¼")
                print("[ç³»ç»Ÿ] æ­å–œæ‚¨æˆ˜èƒœäº†AIï¼")
                break
            
            # æ­¥éª¤4: æ£€æŸ¥æ˜¯å¦å¹³å±€
            if full(chess):
                print("\nğŸ¤ [æ¸¸æˆç»“æŸ] å¹³å±€ï¼")
                print("[ç³»ç»Ÿ] åŒæ–¹å®åŠ›ç›¸å½“ï¼Œä¸åˆ†èƒœè´Ÿï¼")
                break

            # æ­¥éª¤5: å¦‚æœæ²¡æœ‰ä½œå¼Šï¼Œæ‰§è¡ŒAIç§»åŠ¨
            if not position_changed:
                print("\n[AI] è½®åˆ°AIç§»åŠ¨...")
                computer_move_count += 1
                
                # é‡å®šå‘stdoutä»¥æ•è·AIç§»åŠ¨çš„è¾“å‡º
                old_stdout = sys.stdout
                new_stdout = io.StringIO()
                sys.stdout = new_stdout

                # æ‰§è¡ŒAIç§»åŠ¨è®¡ç®—
                chess = computermove(chess)

                # æ¢å¤stdoutå¹¶è·å–AIé€‰æ‹©çš„ä½ç½®
                output = new_stdout.getvalue().strip()
                sys.stdout = old_stdout

                # è§£æAIç§»åŠ¨ä½ç½®
                try:
                    move_position = int(output)
                    print(f"[AI] AIé€‰æ‹©ä½ç½®: {move_position}")
                    
                    # æ„é€ å¹¶å‘é€æ§åˆ¶æ¶ˆæ¯
                    message = f'2{computer_move_count}{move_position}'
                    print(f"[é€šä¿¡] å‘é€æ§åˆ¶æŒ‡ä»¤: {message}")
                    send_message(message)
                    
                except ValueError:
                    print(f"[é”™è¯¯] æ— æ³•è§£æAIç§»åŠ¨è¾“å‡º: {output}")
                    continue

                # æ˜¾ç¤ºæ›´æ–°åçš„æ£‹ç›˜
                print_board(chess)
                
                # æ­¥éª¤6: æ£€æŸ¥AIæ˜¯å¦è·èƒœ
                if winnerdetect(chess, 2):
                    print("\nğŸ¤– [æ¸¸æˆç»“æŸ] AIè·èƒœï¼")
                    print("[ç³»ç»Ÿ] AIå±•ç°äº†å¼ºå¤§çš„è®¡ç®—èƒ½åŠ›ï¼")
                    break
                    
                # æ­¥éª¤7: å†æ¬¡æ£€æŸ¥æ˜¯å¦å¹³å±€
                if full(chess):
                    print("\nğŸ¤ [æ¸¸æˆç»“æŸ] å¹³å±€ï¼")
                    print("[ç³»ç»Ÿ] åŒæ–¹å®åŠ›ç›¸å½“ï¼Œä¸åˆ†èƒœè´Ÿï¼")
                    break
            else:
                print("[è­¦å‘Š] æ£€æµ‹åˆ°ä½œå¼Šè¡Œä¸ºï¼Œè¯·é‡æ–°æ”¾ç½®æ£‹å­")
                print("[æç¤º] è¯·åœ¨ç©ºä½æ”¾ç½®æ–°æ£‹å­ï¼Œä¸è¦ç§»åŠ¨å·²æœ‰æ£‹å­")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n[ç³»ç»Ÿ] ç”¨æˆ·ä¸­æ–­ï¼Œæ¸¸æˆç»“æŸ")
    except Exception as e:
        print(f"\n[é”™è¯¯] ç¨‹åºè¿è¡Œå‡ºç°å¼‚å¸¸: {e}")
        print("[ç³»ç»Ÿ] è¯·æ£€æŸ¥æ‘„åƒå¤´å’Œä¸²å£è¿æ¥")
    finally:
        print("[ç³»ç»Ÿ] ç¨‹åºé€€å‡º")